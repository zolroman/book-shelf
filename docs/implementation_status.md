# Implementation Status

## Completed in this iteration
- Phase 0 baseline scaffold:
  - solution/projects created;
  - repository-level settings and `.gitignore`;
  - CI workflow (`.github/workflows/ci.yml`).
- Phase 1 domain baseline:
  - entities and enums for books, formats, library, downloads, progress, history, local assets;
  - core invariants (progress/rating bounds, download status transitions).
- Phase 2 API baseline:
  - controllers for auth, books, library, search, downloads, progress, history, assets;
  - request parsing and exception middleware;
  - API contracts draft in `docs/api_contracts.md`.
- Phase 3 search integration baseline:
  - `FantLabBookSearchProvider` with resilient flow (retry + circuit-breaker + fallback to local search);
  - response normalization from variable JSON structures into internal book model;
  - short-term query cache for repeated searches;
  - import/upsert of external search results into repository.
- Phase 4 download pipeline baseline:
  - `DownloadPipelineService` orchestrates candidate search, enqueue, status sync, cancel, and idempotent start;
  - Jackett adapter (`JackettTorrentSearchClient`) with Torznab parsing + mock fallback;
  - qBittorrent adapter (`QbittorrentDownloadClient`) with API integration + mock fallback;
  - `DownloadJob` lifecycle persisted in repository and synchronized from external status;
  - completed downloads create/update `LocalAsset` metadata automatically.
- App baseline (Phase 5 skeleton):
  - MAUI Hybrid Blazor app with tabs/pages: dashboard, shelf, search, history;
  - API client + offline JSON cache fallback.
- Phase 6 reader/audio baseline:
  - new client pages:
    - `/read/{bookId}` for text navigation (chapter/page model);
    - `/listen/{bookId}` for audio controls (play/pause/seek/speed) with timer-driven playback simulation;
  - unified client session service (`ReadingSessionService`) for text/audio checkpoints;
  - checkpoint persistence in local SQLite (`bookshelf_sessions.db`) with offline restore across app restart;
  - progress sync via `/api/progress` and history events via `/api/history`;
  - independent positions for text and audio formats of the same book.
- Phase 7 offline-first sync baseline:
  - offline SQLite state store (`bookshelf_offline.db`) with schema for:
    - metadata cache (`metadata_cache`);
    - pending sync queue (`pending_sync_operations`);
    - local asset index (`local_assets_index`);
  - offline sync engine (`OfflineSyncService`):
    - immediate online sync attempt for progress/history events;
    - queue-on-failure/offline + periodic/background flush;
    - reconnect-triggered flush on connectivity changes;
  - conflict policy:
    - progress snapshots: latest timestamp wins (skip stale local snapshot if remote is newer);
    - history events: append-only replay from queue;
  - connectivity-aware app shell status (online/offline + pending queue + last sync outcome).
- Phase 8 history persistence guarantee:
  - added client storage management screen (`/assets`) for local file deletion flow;
  - local deletion path updates only local asset state (`/api/assets/{bookFormatId}`);
  - explicit retention rule documented in repository contract and controller;
  - regression tests verify library/progress/history survive local asset deletion.
- Phase 9 observability/security/hardening baseline:
  - structured JSON logging with correlation scope (`X-Correlation-Id`);
  - security headers middleware (`CSP`, `X-Frame-Options`, `X-Content-Type-Options`, `Referrer-Policy`, `Permissions-Policy`);
  - API fixed-window rate limiting (429 on overload);
  - readiness/liveness health endpoints:
    - `/health/live`
    - `/health/ready` (repository + external integration config checks);
  - retry/backoff hardening for Jackett and qBittorrent adapters;
  - auth token storage strategy review documented in `docs/auth_token_storage_strategy.md`.
- Tests:
  - domain/infrastructure/api unit tests are green locally.

## Not completed yet (next iterations)
- PostgreSQL persistence and EF migrations.
- Production validation against live FantLab schema variations and rate limits.
- Production hardening of Jackett/qBittorrent integrations (auth/availability/rate limits across real deployments).
- OIDC integration with Authelia.
- Full EPUB rendering engine and native background audio playback integration.
- Advanced cross-device merge policies beyond timestamp/append-only baseline.

## Verification snapshot
- Backend build: success.
- MAUI Windows build: success.
- Unit tests: success.
- API smoke test: success (`books`, `search`, `library add/list`, `downloads candidates/start/status/assets`, `progress text/audio`, `history started/completed`).
