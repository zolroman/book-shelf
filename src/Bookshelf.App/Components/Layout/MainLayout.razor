@inherits LayoutComponentBase
@implements IDisposable
@inject IOfflineSyncService OfflineSyncService

<div class="shell">
    <header class="shell-header">
        <div>
            <p class="app-badge">Bookshelf</p>
            <strong>Read, listen, and keep history offline.</strong>
        </div>
        <div class="sync-state @(_syncStatus.IsOnline ? "sync-online" : "sync-offline")">
            <span>@(_syncStatus.IsOnline ? "Online" : "Offline")</span>
            <span>Queue: @_syncStatus.PendingAfter</span>
            @if (_syncStatus.Succeeded > 0 || _syncStatus.Failed > 0)
            {
                <span>Last sync +@_syncStatus.Succeeded / -@_syncStatus.Failed</span>
            }
        </div>
    </header>

    <nav class="shell-nav">
        <NavLink href="/" Match="NavLinkMatch.All">Dashboard</NavLink>
        <NavLink href="/shelf">Shelf</NavLink>
        <NavLink href="/search">Search</NavLink>
        <NavLink href="/history">History</NavLink>
    </nav>

    <main class="shell-content">
        @Body
    </main>
</div>

@code {
    private OfflineSyncStatus _syncStatus = new(
        IsOnline: false,
        PendingBefore: 0,
        Succeeded: 0,
        Failed: 0,
        PendingAfter: 0,
        CheckedAtUtc: DateTime.UtcNow);

    protected override async Task OnInitializedAsync()
    {
        OfflineSyncService.StatusChanged += OnSyncStatusChanged;
        OfflineSyncService.Start();
        _syncStatus = await OfflineSyncService.GetStatusAsync();
    }

    private void OnSyncStatusChanged(OfflineSyncStatus status)
    {
        _syncStatus = status;
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        OfflineSyncService.StatusChanged -= OnSyncStatusChanged;
    }
}
