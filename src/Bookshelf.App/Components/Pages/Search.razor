@page "/search"
@inject IBookshelfApiClient ApiClient

<section class="card">
    <h1>Find a Book</h1>
    <div class="search-row">
        <input type="text" placeholder="Title or author" @bind="_query" @bind:event="oninput" />
        <button class="btn" @onclick="SearchAsync" disabled="@_searching">Search</button>
    </div>
    @if (!string.IsNullOrWhiteSpace(_status))
    {
        <p class="status">@_status</p>
    }
</section>

<section class="card">
    @if (_searching)
    {
        <p>Searching...</p>
    }
    else if (_results.Count == 0)
    {
        <p>Enter query to search for books.</p>
    }
    else
    {
        <div class="books-grid">
            @foreach (var result in _results)
            {
                <article class="book-card">
                    <h3>@result.Title</h3>
                    <p class="meta">@string.Join(", ", result.Authors.Select(a => a.Name))</p>
                    <p class="meta">Rating: @(result.CommunityRating?.ToString("0.0") ?? "-")</p>
                    <p class="meta">Formats: @(result.HasText ? "text" : "") @(result.HasAudio ? " audio" : "")</p>
                    <button class="btn" @onclick="() => AddToShelfAsync(result.Id)">Add To Shelf</button>
                </article>
            }
        </div>
    }
</section>

@code {
    private string _query = string.Empty;
    private string _status = string.Empty;
    private bool _searching;
    private IReadOnlyList<BookSummaryDto> _results = [];

    private async Task SearchAsync()
    {
        _searching = true;
        _status = string.Empty;
        _results = await ApiClient.SearchAsync(_query, CancellationToken.None);
        _searching = false;

        if (_results.Count == 0)
        {
            _status = "No results found. If backend is unavailable, only cached data is shown.";
        }
    }

    private async Task AddToShelfAsync(int bookId)
    {
        var success = await ApiClient.AddToLibraryAsync(userId: 1, bookId: bookId, CancellationToken.None);
        _status = success ? "Book added to shelf." : "Unable to add book (offline or API unavailable).";
    }
}
