@inherits LayoutComponentBase
@implements IDisposable
@inject NavigationManager NavigationManager
@inject UserSessionState UserSessionState
@inject IOfflineSyncService OfflineSyncService

<div class="app-shell">
    <header class="top-bar">
        <a class="brand" href="/">
            <span class="brand-mark">BS</span>
            <span>BookShelf</span>
        </a>

        <nav class="top-nav" aria-label="Primary navigation">
            <NavLink href="/" Match="NavLinkMatch.All">Search</NavLink>
            <NavLink href="/jobs">Jobs</NavLink>
            <NavLink href="/library">Library</NavLink>
            <NavLink href="/shelves">Shelves</NavLink>
        </nav>

        <div class="session-panel">
            <label class="session-label" for="user-id-input">User ID</label>
            <input
                id="user-id-input"
                class="session-input touch-target"
                inputmode="numeric"
                pattern="[0-9]*"
                type="number"
                min="1"
                @bind="_userIdInput"
                @bind:event="oninput" />
            <button class="btn btn-secondary touch-target" type="button" @onclick="ApplyUserId">
                Apply
            </button>
        </div>
    </header>

    @if (OfflineSyncService.IsOffline)
    {
        <div class="offline-banner" role="status">
            Offline mode enabled. Add/download is disabled. Read/listen local media and queue progress/history updates.
        </div>
    }

    <div class="session-token-hint">
        Library auth header: <code>Bearer uid:@UserSessionState.UserId</code>
        <span class="sync-indicator">
            Sync: @OfflineSyncService.StatusText
            @if (OfflineSyncService.LastSyncAtUtc.HasValue)
            {
                <span>(last @OfflineSyncService.LastSyncAtUtc.Value.ToString("HH:mm:ss"))</span>
            }
        </span>
        <button
            class="btn btn-secondary touch-target"
            type="button"
            disabled="@OfflineSyncService.IsSyncing"
            @onclick="TriggerManualSyncAsync">
            Sync now
        </button>
    </div>

    <main class="page-content">
        @Body
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">X</span>
</div>

@code {
    private long _userIdInput;

    protected override async Task OnInitializedAsync()
    {
        _userIdInput = UserSessionState.UserId;
        OfflineSyncService.Changed += OnSyncStateChanged;
        await OfflineSyncService.EnsureStartedAsync();
    }

    public void Dispose()
    {
        OfflineSyncService.Changed -= OnSyncStateChanged;
    }

    private void ApplyUserId()
    {
        if (_userIdInput <= 0)
        {
            _userIdInput = UserSessionState.UserId;
            return;
        }

        UserSessionState.UserId = _userIdInput;
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: false);
    }

    private async Task TriggerManualSyncAsync()
    {
        await OfflineSyncService.TriggerManualSyncAsync();
    }

    private void OnSyncStateChanged(object? sender, EventArgs e)
    {
        _ = InvokeAsync(StateHasChanged);
    }
}
